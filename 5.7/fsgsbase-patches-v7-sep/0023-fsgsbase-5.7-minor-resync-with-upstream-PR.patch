From 8582a52e2f28dc9fb66f8151c60d24f4e6799318 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Wed, 5 Aug 2020 16:49:41 +0200
Subject: [PATCH 23/23] fsgsbase-5.7: minor resync with upstream PR

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 arch/x86/kernel/process_64.c | 4 ++++
 arch/x86/kernel/ptrace.c     | 4 ++--
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/arch/x86/kernel/process_64.c b/arch/x86/kernel/process_64.c
index 86b2eeb7c..da88cbe86 100644
--- a/arch/x86/kernel/process_64.c
+++ b/arch/x86/kernel/process_64.c
@@ -166,7 +166,9 @@ static noinline unsigned long __rdgsbase_inactive(void)
 		gsbase = rdgsbase();
 		native_swapgs();
 	} else {
+		instrumentation_begin();
 		rdmsrl(MSR_KERNEL_GS_BASE, gsbase);
+		instrumentation_end();
 	}
 
 	return gsbase;
@@ -187,7 +189,9 @@ static noinline void __wrgsbase_inactive(unsigned long gsbase)
 		wrgsbase(gsbase);
 		native_swapgs();
 	} else {
+		instrumentation_begin();
 		wrmsrl(MSR_KERNEL_GS_BASE, gsbase);
+		instrumentation_end();
 	}
 }
 NOKPROBE_SYMBOL(__wrgsbase_inactive);
diff --git a/arch/x86/kernel/ptrace.c b/arch/x86/kernel/ptrace.c
index 3ae271830..1f9d3e912 100644
--- a/arch/x86/kernel/ptrace.c
+++ b/arch/x86/kernel/ptrace.c
@@ -882,7 +882,7 @@ static int putreg32(struct task_struct *child, unsigned regno, u32 value)
 		if (ret == 0)
 			child->thread.fsbase =
 				x86_fsgsbase_read_task(child, value);
-		break;
+		return ret;
 
 	case offsetof(struct user32, regs.gs):
 		ret = set_segment_reg(child,
@@ -891,7 +891,7 @@ static int putreg32(struct task_struct *child, unsigned regno, u32 value)
 		if (ret == 0)
 			child->thread.gsbase =
 				x86_fsgsbase_read_task(child, value);
-		break;
+		return ret;
 
 	SEG32(ss);
 
-- 
2.28.0.rc2.1.g3d20111cbd

